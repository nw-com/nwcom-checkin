rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // 大頭照圖片規則
    match /avatars/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null 
        && request.auth.token.email.split("@")[0] == userId
        && request.resource.size < 2 * 1024 * 1024  // 2MB限制
        && (request.resource.contentType.matches('image/jpeg') || 
            request.resource.contentType.matches('image/png') || 
            request.resource.contentType.matches('image/jpg'));
    }
    
    // 文件附件規則
    match /documents/{documentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null 
        && request.resource.size < 10 * 1024 * 1024  // 10MB限制
        && (request.resource.contentType.matches('application/pdf') || 
            request.resource.contentType.matches('image/jpeg') || 
            request.resource.contentType.matches('image/png') ||
            request.resource.contentType.matches('application/msword') ||
            request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document'));
    }
    
    // 系統文件規則（僅管理員）
    match /system/{allPaths=**} {
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.token.email.split("@")[0])).data.role == 'ADMIN';
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.token.email.split("@")[0])).data.role == 'ADMIN';
    }
    
    // 預設拒絕所有其他請求
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}