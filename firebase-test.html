<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 連接測試 - 西北勤務管理系統</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        .header {
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2d3436;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .header p {
            color: #636e72;
            margin: 0;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        .test-section h3 {
            color: #2d3436;
            margin-top: 0;
            display: flex;
            align-items: center;
        }
        .test-section h3 i {
            margin-right: 10px;
        }
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .btn {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin: 10px;
        }
        .btn:hover {
            background: #5f3dc4;
        }
        .btn-success {
            background: #00b894;
        }
        .btn-success:hover {
            background: #00a085;
        }
        .console {
            background: #2d3436;
            color: #ddd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <i class="fas fa-network-wired" style="font-size: 48px; color: #6c5ce7; margin-bottom: 20px;"></i>
            <h1>Firebase 連接測試</h1>
            <p>檢查系統連接狀態和問題</p>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-fire"></i> Firebase 初始化狀態</h3>
            <div id="firebaseStatus" class="status pending">
                <i class="fas fa-clock"></i> 檢測中...
            </div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-users"></i> 身份驗證狀態</h3>
            <div id="authStatus" class="status pending">
                <i class="fas fa-clock"></i> 檢測中...
            </div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-database"></i> Firestore 連接狀態</h3>
            <div id="firestoreStatus" class="status pending">
                <i class="fas fa-clock"></i> 檢測中...
            </div>
        </div>

        <div class="test-section">
            <h3><i class="fas fa-info-circle"></i> 詳細資訊</h3>
            <div id="console" class="console">
                等待檢測結果...
            </div>
        </div>

        <div id="actions" class="hidden">
            <button class="btn" onclick="runTests()">
                <i class="fas fa-redo"></i> 重新檢測
            </button>
            <button class="btn btn-success" onclick="goToLogin()">
                <i class="fas fa-sign-in-alt"></i> 前往登入頁面
            </button>
            <button class="btn" onclick="goToReset()">
                <i class="fas fa-key"></i> 前往重設工具
            </button>
        </div>

        <div id="recommendations" class="test-section hidden">
            <h3><i class="fas fa-lightbulb"></i> 建議解決方案</h3>
            <div id="recommendationsContent"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#3498db';
            console.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        function updateStatus(elementId, status, message, icon) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
        }

        function showRecommendations(recommendations) {
            const recommendationsDiv = document.getElementById('recommendations');
            const content = document.getElementById('recommendationsContent');
            
            let html = '<ul>';
            recommendations.forEach(rec => {
                html += `<li>${rec}</li>`;
            });
            html += '</ul>';
            
            content.innerHTML = html;
            recommendationsDiv.classList.remove('hidden');
        }

        async function runTests() {
            const actions = document.getElementById('actions');
            const recommendations = [];
            
            actions.classList.add('hidden');
            document.getElementById('recommendations').classList.add('hidden');
            
            log('🚀 開始 Firebase 連接測試...');
            
            // 測試 Firebase 初始化
            try {
                log('🔍 檢查 Firebase 初始化狀態...');
                
                if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                    updateStatus('firebaseStatus', 'success', 'Firebase 已成功初始化', 'check-circle');
                    log('✅ Firebase 初始化成功', 'success');
                } else {
                    updateStatus('firebaseStatus', 'error', 'Firebase 初始化失敗', 'times-circle');
                    log('❌ Firebase 初始化失敗', 'error');
                    recommendations.push('檢查 firebase-config.js 檔案是否存在且正確載入');
                    recommendations.push('確認 Firebase 設定物件是否正確');
                }
            } catch (error) {
                updateStatus('firebaseStatus', 'error', `Firebase 錯誤: ${error.message}`, 'times-circle');
                log(`❌ Firebase 初始化錯誤: ${error.message}`, 'error');
                recommendations.push('檢查 Firebase SDK 是否正確載入');
            }

            // 等待一下讓系統初始化
            await new Promise(resolve => setTimeout(resolve, 1000));

            // 測試身份驗證
            try {
                log('🔍 檢查身份驗證狀態...');
                
                if (firebase.auth()) {
                    updateStatus('authStatus', 'success', '身份驗證服務可用', 'check-circle');
                    log('✅ Firebase Auth 服務正常', 'success');
                    
                    // 檢查當前用戶狀態
                    const user = firebase.auth().currentUser;
                    if (user) {
                        log(`👤 當前已登入用戶: ${user.email}`, 'success');
                    } else {
                        log('👤 目前沒有用戶登入', 'info');
                    }
                } else {
                    updateStatus('authStatus', 'error', '身份驗證服務不可用', 'times-circle');
                    log('❌ Firebase Auth 服務異常', 'error');
                    recommendations.push('確認 Firebase Auth SDK 已載入');
                    recommendations.push('檢查 Firebase 控制台中的 Auth 設定');
                }
            } catch (error) {
                updateStatus('authStatus', 'error', `身份驗證錯誤: ${error.message}`, 'times-circle');
                log(`❌ Firebase Auth 錯誤: ${error.message}`, 'error');
                recommendations.push('檢查 Auth 網域設定是否正確');
            }

            // 測試 Firestore
            try {
                log('🔍 檢查 Firestore 連接...');
                
                if (firebase.firestore()) {
                    // 嘗試讀取用戶集合
                    const db = firebase.firestore();
                    
                    try {
                        const usersRef = db.collection('users').doc('ADMIN001');
                        const doc = await usersRef.get();
                        
                        if (doc.exists) {
                            updateStatus('firestoreStatus', 'success', 'Firestore 連接正常，管理員帳號存在', 'check-circle');
                            log('✅ Firestore 連接成功，管理員帳號已存在', 'success');
                            log(`📋 管理員資料: ${JSON.stringify(doc.data(), null, 2)}`, 'success');
                        } else {
                            updateStatus('firestoreStatus', 'warning', 'Firestore 連接正常，但管理員帳號不存在', 'exclamation-triangle');
                            log('⚠️ Firestore 連接成功，但管理員帳號不存在', 'warning');
                            recommendations.push('管理員帳號不存在，需要使用重設工具創建');
                        }
                    } catch (readError) {
                        updateStatus('firestoreStatus', 'warning', 'Firestore 連接正常但讀取失敗', 'exclamation-triangle');
                        log(`⚠️ Firestore 連接成功但讀取失敗: ${readError.message}`, 'warning');
                        recommendations.push('檢查 Firestore 規則是否允許讀取操作');
                        recommendations.push('確認資料庫結構是否正確');
                    }
                } else {
                    updateStatus('firestoreStatus', 'error', 'Firestore 服務不可用', 'times-circle');
                    log('❌ Firestore 服務異常', 'error');
                    recommendations.push('確認 Firestore SDK 已載入');
                    recommendations.push('檢查 Firebase 控制台中的 Firestore 設定');
                }
            } catch (error) {
                updateStatus('firestoreStatus', 'error', `Firestore 錯誤: ${error.message}`, 'times-circle');
                log(`❌ Firestore 連接錯誤: ${error.message}`, 'error');
                recommendations.push('檢查網路連線狀態');
                recommendations.push('確認 Firestore 資料庫已正確創建');
            }

            // 顯示總結和建議
            log('📊 測試完成', 'info');
            actions.classList.remove('hidden');
            
            if (recommendations.length > 0) {
                showRecommendations(recommendations);
            } else {
                log('🎉 所有測試通過！系統應該可以正常運作', 'success');
            }
        }

        function goToLogin() {
            window.location.href = 'index.html';
        }

        function goToReset() {
            window.location.href = 'auto-reset.html';
        }

        // 頁面載入後自動開始測試
        window.addEventListener('load', () => {
            log('🚀 開始載入 Firebase 測試...');
            
            // 等待 Firebase 初始化
            setTimeout(() => {
                runTests();
            }, 2000);
        });
    </script>
</body>
</html>