<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整功能測試 - 西北勤務管理系統</title>
    <link rel="stylesheet" href="ccs/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .test-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .console-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-vial"></i> 完整功能測試</h1>
        
        <div class="test-section">
            <h2><i class="fas fa-cog"></i> 系統初始化測試</h2>
            <div id="initTest"></div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-user-shield"></i> 身份驗證測試</h2>
            <div id="authTest"></div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-file-alt"></i> 頁面管理器測試</h2>
            <div id="pageManagerTest"></div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-mouse-pointer"></i> 導航事件測試</h2>
            <div id="navigationTest"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="testNavigation()">測試導航功能</button>
                <button class="btn btn-secondary" onclick="testModal()">測試彈窗功能</button>
                <button class="btn btn-info" onclick="testSidebar()">測試側邊欄</button>
            </div>
        </div>

        <div class="test-section">
            <h2><i class="fas fa-terminal"></i> 控制台輸出</h2>
            <div id="consoleOutput" class="console-output"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- 應用程式腳本 -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/pages.js"></script>
    <script src="js/app.js"></script>

    <script>
        // 控制台輸出捕獲
        const consoleOutput = document.getElementById('consoleOutput');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addConsoleOutput(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            consoleOutput.innerHTML += `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addConsoleOutput('log', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addConsoleOutput('error', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addConsoleOutput('warn', args.join(' '));
        };

        // 測試函數
        function showResult(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML += `<div class="test-result test-${type}">${message}</div>`;
        }

        // 系統初始化測試
        function testInitialization() {
            console.log('開始系統初始化測試...');
            
            // 測試全域物件
            if (typeof window.nwComApp !== 'undefined') {
                showResult('initTest', '✓ NWComApp 全域物件已載入', 'success');
            } else {
                showResult('initTest', '✗ NWComApp 全域物件未找到', 'error');
            }

            if (typeof window.pageManager !== 'undefined') {
                showResult('initTest', '✓ PageManager 全域物件已載入', 'success');
            } else {
                showResult('initTest', '✗ PageManager 全域物件未找到', 'error');
            }

            if (typeof window.authManager !== 'undefined') {
                showResult('initTest', '✓ AuthManager 全域物件已載入', 'success');
            } else {
                showResult('initTest', '✗ AuthManager 全域物件未找到', 'error');
            }

            // 測試初始化狀態
            setTimeout(() => {
                if (window.nwComApp && window.nwComApp.isInitialized) {
                    showResult('initTest', '✓ NWComApp 已成功初始化', 'success');
                } else {
                    showResult('initTest', '⚠ NWComApp 初始化狀態未知', 'warning');
                }
            }, 1000);
        }

        // 身份驗證測試
        function testAuthentication() {
            console.log('開始身份驗證測試...');
            
            if (firebase && firebase.auth) {
                showResult('authTest', '✓ Firebase Auth 已載入', 'success');
            } else {
                showResult('authTest', '✗ Firebase Auth 未載入', 'error');
            }

            if (window.authManager) {
                showResult('authTest', '✓ AuthManager 已初始化', 'success');
                
                // 測試當前用戶狀態
                const currentUser = window.authManager.getCurrentUser();
                if (currentUser) {
                    showResult('authTest', `✓ 當前用戶: ${currentUser.name} (${currentUser.role})`, 'success');
                } else {
                    showResult('authTest', '⚠ 無當前用戶（可能未登入）', 'warning');
                }
            } else {
                showResult('authTest', '✗ AuthManager 未初始化', 'error');
            }
        }

        // 頁面管理器測試
        function testPageManager() {
            console.log('開始頁面管理器測試...');
            
            if (window.pageManager) {
                showResult('pageManagerTest', '✓ PageManager 已初始化', 'success');
                
                // 測試頁面定義
                const pages = window.pageManager.pages;
                if (pages && Object.keys(pages).length > 0) {
                    showResult('pageManagerTest', `✓ 已定義 ${Object.keys(pages).length} 個頁面`, 'success');
                    
                    // 顯示頁面列表
                    Object.keys(pages).forEach(pageName => {
                        showResult('pageManagerTest', `  - ${pageName}: ${pages[pageName].title}`, 'success');
                    });
                } else {
                    showResult('pageManagerTest', '⚠ 無頁面定義', 'warning');
                }
                
                // 測試方法存在性
                const methods = ['loadPage', 'toggleSidebar', 'checkPagePermission', 'updateActiveMenu'];
                methods.forEach(method => {
                    if (typeof window.pageManager[method] === 'function') {
                        showResult('pageManagerTest', `✓ 方法 ${method} 已定義`, 'success');
                    } else {
                        showResult('pageManagerTest', `✗ 方法 ${method} 未定義`, 'error');
                    }
                });
                
            } else {
                showResult('pageManagerTest', '✗ PageManager 未初始化', 'error');
            }
        }

        // 導航事件測試
        function testNavigation() {
            console.log('測試導航功能...');
            
            if (window.pageManager) {
                // 測試載入儀表板
                window.pageManager.loadPage('dashboard').then(() => {
                    showResult('navigationTest', '✓ 儀表板頁面載入成功', 'success');
                }).catch(error => {
                    showResult('navigationTest', `✗ 儀表板載入失敗: ${error.message}`, 'error');
                });
                
                // 測試其他頁面
                setTimeout(() => {
                    window.pageManager.loadPage('personal').then(() => {
                        showResult('navigationTest', '✓ 個人資訊頁面載入成功', 'success');
                    }).catch(error => {
                        showResult('navigationTest', `✗ 個人資訊載入失敗: ${error.message}`, 'error');
                    });
                }, 1000);
            } else {
                showResult('navigationTest', '✗ PageManager 未初始化，無法測試導航', 'error');
            }
        }

        // 測試彈窗功能
        function testModal() {
            if (window.nwComApp && window.nwComApp.showModal) {
                window.nwComApp.showModal('測試彈窗', '<p>這是一個測試彈窗！</p><button class="btn btn-primary" onclick="window.nwComApp.closeAllModals()">關閉</button>');
                showResult('navigationTest', '✓ 彈窗功能正常', 'success');
            } else {
                showResult('navigationTest', '✗ 無法顯示彈窗', 'error');
            }
        }

        // 測試側邊欄
        function testSidebar() {
            if (window.nwComApp && window.nwComApp.toggleSidebar) {
                window.nwComApp.toggleSidebar();
                showResult('navigationTest', '✓ 側邊欄切換功能正常', 'success');
                
                setTimeout(() => {
                    window.nwComApp.toggleSidebar();
                    showResult('navigationTest', '✓ 側邊欄已關閉', 'success');
                }, 1000);
            } else {
                showResult('navigationTest', '✗ 無法切換側邊欄', 'error');
            }
        }

        // 頁面載入完成後執行測試
        document.addEventListener('DOMContentLoaded', function() {
            console.log('測試頁面已載入，開始執行測試...');
            
            // 延遲執行，確保所有腳本載入完成
            setTimeout(() => {
                testInitialization();
                
                setTimeout(() => {
                    testAuthentication();
                    testPageManager();
                }, 500);
            }, 1000);
        });
    </script>
</body>
</html>